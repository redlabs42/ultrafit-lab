# Ultrafit Lab - Regras do Cursor

## üéØ Contexto do Projeto

Ultrafit Lab √© uma plataforma de IA para nutri√ß√£o e treinos de academia, constru√≠da com arquitetura serverless na AWS.

**Stack Principal:**

- Frontend: Next.js 16 + React 19 + TypeScript + Tailwind CSS 4
- Backend: AWS Lambda (Node.js/TypeScript)
- Infraestrutura: Pulumi (TypeScript)
- Gerenciador de pacotes: pnpm

## üìã Regras Obrigat√≥rias - N√≠vel Pleno/S√™nior

### 1. Observability

- **Logs estruturados**: Sempre usar `pino` com logs estruturados (n√£o console.log)
- **M√©tricas**: Implementar P50/P95/P99 para endpoints cr√≠ticos
- **Tracing**: Adicionar tracing para servi√ßos distribu√≠dos e endpoints cr√≠ticos

### 2. Deploy Seguro

- **CI/CD automatizado**: Todas as mudan√ßas via PR com CI/CD
- **Canary/Blue-Green**: Usar estrat√©gias de deploy seguras
- **Feature flags**: Para rollout gradual e rollback r√°pido

### 3. Code Review Obrigat√≥rio

- **PRs pequenas**: M√°ximo 400 linhas por PR
- **Checklist**: Tests, migrations, changelog sempre inclu√≠dos
- **2 reviewers**: Para mudan√ßas cr√≠ticas (infra, auth, payments)

### 4. API Contract & Versionamento

- **Breaking changes**: Apenas via nova vers√£o de API
- **Documenta√ß√£o**: Sempre documentar migra√ß√£o de vers√µes
- **Backward compatibility**: Manter compatibilidade quando poss√≠vel

### 5. Feature Flags

- **Ciclo de vida**: Definir dono, data de cria√ß√£o e data de remo√ß√£o
- **Remo√ß√£o**: Remover flags curtas (< 30 dias) automaticamente
- **Documenta√ß√£o**: Documentar prop√≥sito de cada flag

### 6. Gest√£o de Depend√™ncias e Seguran√ßa

- **SCA autom√°tico**: Verificar vulnerabilidades automaticamente
- **Pol√≠tica de updates**: Atualizar depend√™ncias regularmente
- **Secrets**: Nunca commitar segredos; usar AWS Secrets Manager/Parameter Store

### 7. Resili√™ncia

- **Timeouts**: Sempre definir timeouts em chamadas externas
- **Retries**: Implementar retries exponenciais entre servi√ßos
- **Circuit breakers**: Para servi√ßos externos cr√≠ticos

### 8. Runbooks & Mentoria

- **Design docs**: Para features complexas
- **Runbooks**: Documentar procedimentos de incidente
- **Pairing**: Para onboarding de novos membros

## üé® Regras de Desenvolvimento

### 1. Mobile-First + Responsivo + A11y

- **Mobile-first**: Sempre desenhar para mobile primeiro
- **Media queries progressivas**: Usar unidades relativas
- **Acessibilidade**: Considerar A11y desde o in√≠cio (ARIA, contraste, navega√ß√£o por teclado)

### 2. KISS/YAGNI

- **Implementar apenas o necess√°rio**: N√£o criar abstra√ß√µes "para o futuro"
- **Evitar over-engineering**: Proibir "talvez no futuro"
- **Simplicidade**: Preferir solu√ß√µes simples e diretas

### 3. C√≥digo Autoexplicativo

- **Nomes claros**: Vari√°veis e fun√ß√µes com nomes descritivos
- **Fun√ß√µes curtas**: M√°ximo 50 linhas por fun√ß√£o
- **Sem coment√°rios redundantes**: C√≥digo deve ser autoexplicativo
- **Comentar apenas o PORQU√ä**: Decis√µes, trade-offs, invariantes

### 4. Seguran√ßa por Padr√£o

- **Nunca commitar segredos**: Verificar .gitignore sempre
- **Sanitizar/validar dados**: Todos os inputs devem ser validados
- **OWASP Top 10**: Mitigar riscos conhecidos
- **Headers de seguran√ßa**: Verificar headers HTTP
- **Uso seguro de libs**: Verificar depend√™ncias regularmente

### 5. Qualidade Cont√≠nua

- **Testes unit√°rios**: Para regras de neg√≥cio cr√≠ticas
- **Poucos E2E cr√≠ticos**: Focar em fluxos principais
- **PRs pequenas**: M√°ximo 400 linhas
- **ESLint/Prettier/TypeScript strict**: Sempre passar
- **Type-check antes de commit**: `pnpm run type-check`

## üîß Conven√ß√µes T√©cnicas

### TypeScript

- **Strict mode**: Sempre habilitado
- **Type safety**: Evitar `any`, usar `unknown` quando necess√°rio
- **Interfaces**: Preferir interfaces sobre types quando poss√≠vel
- **Imports**: Usar imports absolutos quando fizer sentido

### Backend (Lambda)

- **Estrutura**: Cada dom√≠nio tem seu pr√≥prio `package.json`
- **Handler**: Sempre exportar fun√ß√£o `handler` como default
- **Valida√ß√£o**: Usar `zod` para valida√ß√£o de inputs
- **Logging**: Sempre usar `pino` (n√£o console.log)
- **Error handling**: Sempre tratar erros e retornar respostas padronizadas
- **CORS**: Incluir headers CORS em todas as respostas

### Frontend (Next.js)

- **App Router**: Usar App Router (n√£o Pages Router)
- **Server Components**: Preferir Server Components quando poss√≠vel
- **Client Components**: Apenas quando necess√°rio (interatividade, hooks)
- **Formul√°rios**: Usar React Hook Form + Zod
- **Estado**: Zustand para estado global, React Query para dados do servidor
- **Componentes**: Shadcn UI como base, customizar quando necess√°rio

### Commits

- **Conventional Commits**: `feat:`, `fix:`, `docs:`, `refactor:`, etc.
- **Mensagens claras**: Descrever o que e por qu√™
- **Escopo**: Incluir escopo quando relevante (`feat(backend): adiciona valida√ß√£o`)

### Git

- **Branches**: `feature/nome`, `fix/nome`, `refactor/nome`
- **PRs pequenas**: M√°ximo 400 linhas
- **Descri√ß√£o clara**: Sempre descrever o que foi feito e por qu√™

## üìù Padr√µes de C√≥digo

### Backend Lambda

```typescript
// ‚úÖ BOM
export async function handler(
  event: APIGatewayProxyEvent,
  _context: unknown
): Promise<APIGatewayProxyResult> {
  try {
    logger.info({ path: event.path }, "handler_invoked");
    // l√≥gica aqui
    return createSuccessResponse({ data: result });
  } catch (error) {
    logger.error({ error }, "handler_error");
    return createErrorResponse("Erro ao processar", 500);
  }
}

// ‚ùå RUIM
export async function handler(event: any) {
  console.log("test");
  return { statusCode: 200, body: JSON.stringify(event) };
}
```

### Frontend Components

```typescript
// ‚úÖ BOM
export function UserProfile({ userId }: { userId: string }) {
  const { data, isLoading } = useQuery({
    queryKey: ["user", userId],
    queryFn: () => fetchUser(userId),
  });

  if (isLoading) return <Skeleton />;
  if (!data) return <Error />;

  return <div>{data.name}</div>;
}

// ‚ùå RUIM
export function UserProfile(props: any) {
  const [user, setUser] = useState(null);
  useEffect(() => {
    fetch(`/api/user/${props.id}`).then(setUser);
  }, []);
  return <div>{user?.name}</div>;
}
```

## üö´ O Que N√ÉO Fazer

- ‚ùå N√£o usar `console.log` (usar `pino`)
- ‚ùå N√£o usar `any` sem necessidade
- ‚ùå N√£o commitar arquivos `.env` ou secrets
- ‚ùå N√£o criar abstra√ß√µes "para o futuro"
- ‚ùå N√£o fazer PRs grandes (> 400 linhas)
- ‚ùå N√£o pular testes em c√≥digo cr√≠tico
- ‚ùå N√£o usar `var` (sempre `const` ou `let`)
- ‚ùå N√£o criar fun√ß√µes muito longas (> 50 linhas)
- ‚ùå N√£o ignorar erros de TypeScript
- ‚ùå N√£o usar bibliotecas sem verificar seguran√ßa

## ‚úÖ Checklist Antes de Commitar

- [ ] Type-check passando (`pnpm run type-check`)
- [ ] Lint passando (`pnpm run lint`)
- [ ] Testes passando (quando aplic√°vel)
- [ ] Sem console.log (usar pino)
- [ ] Sem `any` desnecess√°rio
- [ ] C√≥digo autoexplicativo
- [ ] Commits com Conventional Commits
- [ ] PR descrita claramente

## üìö Refer√™ncias

- **Frontend**: Next.js 16 Docs, React 19 Docs, Shadcn UI
- **Backend**: AWS Lambda Docs, AWS SDK v3
- **Infra**: Pulumi Docs
- **Qualidade**: ESLint, TypeScript Strict, Biome

---

**√öltima atualiza√ß√£o**: 2025-01-27
**Vers√£o**: 1.0.0
